module "alb" {
  source  = "terraform-aws-modules/alb/aws"
  version = "8.4.0"

  load_balancer_type = "application"
  security_groups    = [module.vpc.default_security_group_id, aws_security_group.allow_http.id]
  subnets            = module.vpc.public_subnets
  vpc_id             = module.vpc.vpc_id


  http_tcp_listeners = [
    {
      port               = 80
      protocol           = "HTTP"
      target_group_index = 0
    }
  ]

  # listeners = {
  #   ex-http-https-redirect = {
  #     port     = 80
  #     protocol = "HTTP"
  #     redirect = {
  #       port        = "443"
  #       protocol    = "HTTPS"
  #       status_code = "HTTP_301"
  #     }

  #     ex-https = {
  #       port                        = 443
  #       protocol                    = "HTTPS"
  #       ssl_policy                  = "ELBSecurityPolicy-TLS13-1-2-Res-2021-06"
  #       certificate_arn             = module.acm.acm_certificate_arn
  #       additional_certificate_arns = [module.wildcard_cert.acm_certificate_arn]

  #       forward = {
  #         target_group_key = "ex-instance"
  #       }
  #     }
  #   }
  # }

  # target_groups = {
  #   ex-instance = {
  #     name_prefix                       = "h1"
  #     protocol                          = "HTTP"
  #     port                              = 80
  #     target_type                       = "ip"
  #     deregistration_delay              = 10
  #     load_balancing_cross_zone_enabled = false
  #   }
  # }

  target_groups = [
    {
      backend_port     = 80
      backend_protocol = "HTTP"
      target_type      = "ip"
    }
  ]

  # Route53 Record(s)
  # route53_records = {
  #   A = {
  #     name    = "aws-lab"
  #     type    = "A"
  #     zone_id = data.aws_route53_zone.this.id
  #   }
  #   AAAA = {
  #     name    = "aws-lab"
  #     type    = "AAAA"
  #     zone_id = data.aws_route53_zone.this.id
  #   }
  # }

}

data "aws_route53_zone" "this" {
  name = "aws.yanovsky.cc"
}

module "acm" {
  source  = "terraform-aws-modules/acm/aws"
  version = "~> 4.0"

  domain_name = "lab.aws.yanovsky.cc"
  zone_id     = data.aws_route53_zone.this.id
}

module "wildcard_cert" {
  source  = "terraform-aws-modules/acm/aws"
  version = "~> 4.0"

  domain_name = "*.aws.yanovsky.cc"
  zone_id     = data.aws_route53_zone.this.id
}

resource "aws_route53_record" "record" {
  zone_id = data.aws_route53_zone.this.id
  name    = "lab"
  type    = "CNAME"
  records = ["http://${module.alb.lb_dns_name}"]
  ttl     = 5

  depends_on = [module.alb]
}

output "url" { value = "http://${module.alb.lb_dns_name}" }
